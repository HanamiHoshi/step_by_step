# main.py
import asyncio
import logging
import os
from aiogram import Bot, Dispatcher
from config.settings import BOT_TOKEN
from database.db import init_db
from handlers import start, habits, stats
from utils.scheduler import scheduler, schedule_daily_reminders

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.DEBUG)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

async def main():
    print("üìÇ [MAIN] –¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:", os.getcwd())
    print("üêç [MAIN] –ü—É—Ç—å –∫ main.py:", os.path.abspath(__file__))

    # üü¢ 1. –°–ê–ú–û–ï –ü–ï–†–í–û–ï ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    print("‚è≥ [MAIN] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    await init_db()
    print("‚úÖ [MAIN] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞")

    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
    scheduler.start()
    schedule_daily_reminders(bot)
    print("‚è∞ [MAIN] –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∑–∞–ø—É—â–µ–Ω")

    # üü° 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    print("üîå [MAIN] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤...")
    dp.include_router(start.router)
    dp.include_router(habits.router)
    dp.include_router(stats.router)  # ‚Üê –¥–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
    print("‚úÖ [MAIN] –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã")

    # üîµ 3. –û—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å –∏ –∑–∞–ø—É—Å–∫–∞–µ–º polling
    print("üßπ [MAIN] –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...")
    await bot.delete_webhook(drop_pending_updates=True)

    print("üöÄ [MAIN] –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    try:
        await dp.start_polling(bot)
    finally:
        scheduler.shutdown()  # –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
        print("üõë [MAIN] –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

if __name__ == "__main__":
    print("üèÅ [MAIN] –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...")
    asyncio.run(main())